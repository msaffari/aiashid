<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شروع / استوپ</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        .button-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            padding-bottom: 25px;
        }

        .game-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'IRANYekan', 'Tahoma', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        #demo-image, #demo-video {
            width: 250px;
            height: 250px;
            object-fit: contain;
        }

        .restart-button {
            background-color: #4CAF50;
            color: white;
        }

        .stop-button {
            background-color: #f44336;
            color: white;
        }

        .game-button:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .hidden {
            display: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #FFD93D;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-radius: 30px 30px 0 0;
        }

        .nav-item {
            color: #000000;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .nav-item i {
            font-size: 24px;
        }

        .nav-item span {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-button" title="بازگشت">←</a>
        <h1>شروع / استوپ</h1>
        <div class="header-spacer"></div>
    </div>

    <div class="container">
        <div class="game-box">
            <img id="demo-image" src="assets/demo.jpg" class="demo-video" alt="تصویر راهنمای بازی">
            <video id="demo-video" autoplay loop muted style="display: none;">
                <source src="assets/demo.mp4" type="video/mp4">
                مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
            </video>
            <video id="video" autoplay></video>
            <div id="result">برای شروع بازی دکمه زیر را بزن یا بگو "آشید شروع کن"</div>
            <button id="start-button" class="start-button" onclick="startGame()">شروع بازی</button>
            <div id="control-buttons" class="button-container hidden">
                <button class="game-button restart-button" onclick="startGame()">شروع مجدد</button>
                <button class="game-button stop-button" onclick="stopGame()">توقف بازی</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="https://ai.ashid.ir/" class="nav-item">
            <i class="fas fa-home"></i>
            <span>خانه</span>
        </a>

        <a href="https://ashid.ir/profile" class="nav-item">
            <i class="fas fa-user"></i>
            <span>پروفایل</span>
        </a>

        <a href="https://ashid.ir/reports" class="nav-item">
            <i class="fas fa-chart-line"></i>
            <span>گزارش‌ها</span>
        </a>
    </div>

    <audio id="start-audio" src="assets/start.mp3" preload="auto"></audio>
    <audio id="jump-audio" src="assets/jump.mp3" preload="auto"></audio>
    <audio id="stop-audio" src="assets/stop.mp3" preload="auto"></audio>
    <audio id="success-audio" src="assets/success.mp3" preload="auto"></audio>
    <audio id="fail-audio" src="assets/fail.mp3" preload="auto"></audio>

    <script>
        // غیرفعال کردن پیام‌های دیباگ
        const oldConsoleLog = console.log;
        console.log = function() {
            if (arguments[0]?.includes?.('Successfully created a WebGL context') ||
                arguments[0]?.includes?.('GL version') ||
                arguments[0]?.includes?.('OpenGL error checking')) {
                return;
            }
            oldConsoleLog.apply(console, arguments);
        };

        const videoElement = document.getElementById('video');
        const demoVideo = document.getElementById('demo-video');
        const demoImage = document.getElementById('demo-image');
        const resultElement = document.getElementById('result');
        const startAudio = document.getElementById('start-audio');
        const jumpAudio = document.getElementById('jump-audio');
        const stopAudio = document.getElementById('stop-audio');
        const successAudio = document.getElementById('success-audio');
        const failAudio = document.getElementById('fail-audio');

        // متغیر برای ذخیره وضعیت مجوزها
        let permissionsGranted = {
            camera: false,
            microphone: false
        };

        // تابع برای درخواست همه مجوزهای مورد نیاز در ابتدا
        async function requestAllPermissions() {
            try {
                // درخواست همزمان دوربین و میکروفون
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                console.log('مجوز دوربین و میکروفون با موفقیت دریافت شد');
                
                // ذخیره وضعیت مجوزها
                permissionsGranted.camera = true;
                permissionsGranted.microphone = true;
                
                // در دستگاه‌های موبایل، استریم صوتی را نگه دار تا از قطع و وصل شدن جلوگیری شود
                if (isMobileDevice()) {
                    // فقط ترک تصویری را متوقف کن، ترک صوتی را نگه دار
                    stream.getTracks().forEach(track => {
                        if (track.kind === 'video') {
                            track.stop();
                        }
                    });
                    
                    // ذخیره استریم صوتی برای استفاده بعدی
                    window.persistentAudioStream = stream;
                } else {
                    // در دسکتاپ، منابع استریم را آزاد کن
                    stream.getTracks().forEach(track => {
                        if (track.kind === 'audio') {
                            track.stop();
                        }
                    });
                }
                
                // شروع تشخیص صدا
                if (!isRecognitionActive) {
                    startSpeechRecognition();
                }
                
                return true;
            } catch (error) {
                console.error('خطا در دریافت مجوزها:', error);
                
                // بررسی نوع خطا برای تشخیص کدام مجوز رد شده است
                if (error.name === 'NotAllowedError') {
                    console.error('کاربر مجوز دوربین یا میکروفون را رد کرد');
                } else if (error.name === 'NotFoundError') {
                    console.error('دوربین یا میکروفون در دستگاه یافت نشد');
                }
                
                return false;
            }
        }

        // تابع برای پخش صدا با در نظر گرفتن خطاها
        async function playAudioSafely(audioElement) {
            try {
                if (audioElement) {
                    await audioElement.play();
                    return new Promise(resolve => {
                        audioElement.onended = resolve;
                    });
                }
            } catch (error) {
                console.log('خطا در پخش صدا:', error);
            }
        }

        let isGameActive = false;
        let isStopPhase = false;
        let lastPosePositions = [];
        let gameTimeout;
        let lastResults = null;

        const pose = new Pose({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
            }
        });

        pose.setOptions({
            modelComplexity: 0,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        // راه‌اندازی دوربین فقط اگر مجوز دریافت شده باشد
        function initializeCamera() {
            if (permissionsGranted.camera) {
                const cameraInstance = new Camera(videoElement, {
                    onFrame: async () => {
                        await pose.send({image: videoElement});
                    },
                    width: 333,
                    height: 250
                });
                
                cameraInstance.start();
                return cameraInstance;
            }
            return null;
        }

        // متغیر دوربین را در سطح بالاتر تعریف کن
        let camera = null;

        // درخواست مجوزها و سپس راه‌اندازی دوربین و تشخیص صدا
        requestAllPermissions().then(granted => {
            if (granted) {
                camera = initializeCamera();
                startSpeechRecognition();
            }
        });

        // راه‌اندازی تشخیص صدا
        let recognition;
        let isRecognitionActive = false;
        let microphoneRestartAttempts = 0; // شمارنده تلاش‌های راه‌اندازی مجدد
        const MAX_RESTART_ATTEMPTS = 2; // حداکثر تعداد تلاش‌های مجدد

        function startSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn('مرورگر شما از تشخیص صدا پشتیبانی نمی‌کند');
                showBrowserWarning();
                return;
            }

            if (isRecognitionActive) return;
            
            // اگر مجوز میکروفون دریافت نشده، ابتدا آن را درخواست کن
            if (!permissionsGranted.microphone) {
                requestAllPermissions().then(granted => {
                    if (granted) {
                        initializeSpeechRecognition();
                    }
                });
                return;
            }
            
            initializeSpeechRecognition();
        }
        
        // جداسازی راه‌اندازی تشخیص صدا از درخواست مجوز
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'fa-IR';
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                isRecognitionActive = true;
                console.log('تشخیص صدا فعال شد');
                microphoneRestartAttempts = 0; // ریست کردن شمارنده تلاش‌ها
            };

            recognition.onresult = function(event) {
                const last = event.results.length - 1;
                const command = event.results[last][0].transcript.trim().toLowerCase();
                console.log('دستور شنیده شده:', command);
                
                if (command.includes('آشید شروع کن') || 
                    command.includes('اشید شروع کن') || 
                    command.includes('آشید شروع') || 
                    command.includes('آرشید شروع') ||
                    command.includes('آشیت شروع') ||
                    command.includes('هی شروع') ||
                    command.includes('شروع کن') ||
                    command.includes('شروع') ||
                    command.includes('با توام شروع کن')) {
                    startGame();
                }
            };

            recognition.onerror = function(event) {
                console.error('خطا در تشخیص صدا:', event.error);
                
                // فقط در صورت خطاهای خاص و اگر تعداد تلاش‌ها از حد مجاز کمتر است، تشخیص صدا را مجدداً راه‌اندازی کنید
                if ((event.error === 'network' || event.error === 'service-not-allowed') && microphoneRestartAttempts < MAX_RESTART_ATTEMPTS) {
                    isRecognitionActive = false;
                    microphoneRestartAttempts++;
                    setTimeout(() => restartSpeechRecognition(), 5000);
                } else {
                    // در غیر این صورت، فقط وضعیت را به غیرفعال تغییر دهید بدون راه‌اندازی مجدد
                    isRecognitionActive = false;
                }
            };

            recognition.onend = function() {
                console.log('تشخیص صدا قطع شد');
                
                // فقط اگر تعداد تلاش‌ها از حد مجاز کمتر است، تشخیص صدا را مجدداً راه‌اندازی کنید
                if (microphoneRestartAttempts < MAX_RESTART_ATTEMPTS) {
                    isRecognitionActive = false;
                    microphoneRestartAttempts++;
                    console.log(`تلاش مجدد ${microphoneRestartAttempts} از ${MAX_RESTART_ATTEMPTS}`);
                    setTimeout(() => restartSpeechRecognition(), 5000);
                } else {
                    // در غیر این صورت، فقط وضعیت را به غیرفعال تغییر دهید بدون راه‌اندازی مجدد
                    isRecognitionActive = false;
                    console.log('حداکثر تعداد تلاش‌های راه‌اندازی مجدد انجام شد. تشخیص صدا غیرفعال شد.');
                }
            };

            try {
                recognition.start();
            } catch (error) {
                console.error('خطا در شروع تشخیص صدا:', error);
                isRecognitionActive = false;
                
                // فقط اگر تعداد تلاش‌ها از حد مجاز کمتر است، تشخیص صدا را مجدداً راه‌اندازی کنید
                if (microphoneRestartAttempts < MAX_RESTART_ATTEMPTS) {
                    microphoneRestartAttempts++;
                    setTimeout(() => restartSpeechRecognition(), 5000);
                }
            }
        }

        function showBrowserWarning() {
            let warningDiv = document.createElement('div');
            warningDiv.style.position = 'fixed';
            warningDiv.style.top = '0';
            warningDiv.style.left = '0';
            warningDiv.style.right = '0';
            warningDiv.style.backgroundColor = '#FFA500';
            warningDiv.style.color = 'white';
            warningDiv.style.padding = '10px';
            warningDiv.style.textAlign = 'center';
            warningDiv.style.zIndex = '1000';
            warningDiv.style.fontFamily = 'IRANYekan, Tahoma, sans-serif';
            warningDiv.textContent = '⚠️ جهت اجرای بازی با فرمان صوتی از مرورگر گوگل کروم استفاده کنید';
            document.body.appendChild(warningDiv);

            // تنظیم حاشیه برای هدر تا با پیام هشدار همپوشانی نداشته باشد
            document.querySelector('.header').style.marginTop = '40px';
        }

        function restartSpeechRecognition() {
            if (recognition && !isRecognitionActive && permissionsGranted.microphone) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('خطا در شروع مجدد تشخیص صدا:', error);
                    
                    // تلاش مجدد با تأخیر بیشتر در صورت خطا
                    setTimeout(() => restartSpeechRecognition(), 5000);
                }
            }
        }

        function updateMicrophoneStatus(isActive) {
            // حذف کامل نشانگر میکروفون بالای صفحه
            const existingMicStatus = document.getElementById('mic-status');
            if (existingMicStatus) {
                existingMicStatus.remove();
            }
        }

        // اضافه کردن دکمه برای فعال‌سازی مجدد میکروفون
        function createMicrophoneButton() {
            const micButton = document.createElement('button');
            micButton.id = 'mic-button';
            micButton.textContent = '🎤 فعال‌سازی میکروفون';
            micButton.style.position = 'fixed';
            micButton.style.bottom = '80px';
            micButton.style.left = '10px';
            micButton.style.padding = '8px 12px';
            micButton.style.backgroundColor = '#4CAF50';
            micButton.style.color = 'white';
            micButton.style.border = 'none';
            micButton.style.borderRadius = '5px';
            micButton.style.cursor = 'pointer';
            micButton.style.zIndex = '1000';
            micButton.style.fontFamily = 'IRANYekan, Tahoma, sans-serif';
            
            micButton.onclick = async function() {
                // ریست کامل تشخیص صدا
                resetSpeechRecognition();
            };
            
            document.body.appendChild(micButton);
            
            // به‌روزرسانی وضعیت دکمه بر اساس وضعیت میکروفون
            updateMicButtonStatus(isRecognitionActive);
        }
        
        // تابع برای ریست کامل تشخیص صدا
        function resetSpeechRecognition() {
            // توقف تشخیص صدا فعلی
            if (recognition && isRecognitionActive) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('خطا در توقف تشخیص صدا:', error);
                }
            }
            
            // ریست متغیرها
            isRecognitionActive = false;
            microphoneRestartAttempts = 0;
            
            // درخواست مجدد مجوزها و راه‌اندازی مجدد
            requestAllPermissions().then(granted => {
                if (granted) {
                    startSpeechRecognition();
                    updateMicButtonStatus(true);
                } else {
                    updateMicButtonStatus(false);
                }
            });
        }
        
        // به‌روزرسانی وضعیت دکمه میکروفون
        function updateMicButtonStatus(isActive) {
            const micButton = document.getElementById('mic-button');
            if (!micButton) return;
            
            if (isActive) {
                micButton.textContent = '🎤 میکروفون فعال است';
                micButton.style.backgroundColor = '#4CAF50';
            } else {
                micButton.textContent = '🎤 فعال‌سازی میکروفون';
                micButton.style.backgroundColor = '#f44336';
            }
        }
        
        createMicrophoneButton();

        function onResults(results) {
            lastResults = results;
            if (!isGameActive || !isStopPhase) return;

            if (results.poseLandmarks) {
                const keyPoints = [
                    results.poseLandmarks[11], // شانه راست
                    results.poseLandmarks[12], // شانه چپ
                    results.poseLandmarks[23], // لگن راست
                    results.poseLandmarks[24], // لگن چپ
                ];

                checkMovement(keyPoints);
            }
        }

        function checkMovement(currentPoints) {
            if (lastPosePositions.length === 0) return;

            let totalMovement = 0;
            for (let i = 0; i < currentPoints.length; i++) {
                const dx = currentPoints[i].x - lastPosePositions[i].x;
                const dy = currentPoints[i].y - lastPosePositions[i].y;
                totalMovement += Math.sqrt(dx * dx + dy * dy);
            }

            if (totalMovement > 0.05) {
                gameOver(false);
            }
        }

        async function startGame() {
            // توقف تمام صداها قبل از شروع بازی جدید
            [startAudio, jumpAudio, stopAudio, successAudio, failAudio].forEach(audio => {
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            });

            // پاکسازی تایمرهای قبلی
            clearTimeout(gameTimeout);
            
            // نمایش دکمه‌های کنترل و مخفی کردن دکمه شروع
            document.getElementById('start-button').classList.add('hidden');
            document.getElementById('control-buttons').classList.remove('hidden');

            isGameActive = true;
            isStopPhase = false;
            lastPosePositions = [];
            resultElement.textContent = "Ready...";
            
            // پخش صدای شروع
            await playAudioSafely(startAudio);
            
            // نمایش ویدیو
            demoImage.style.display = 'none';
            demoVideo.style.display = 'block';
            demoVideo.play();
            
            // شروع بازی
            resultElement.textContent = "حالا بالا پایین بپر!";
            await playAudioSafely(jumpAudio);
            
            // زمان تصادفی برای استوپ
            const stopTime = 2000 + Math.random() * 5000;
            
            gameTimeout = setTimeout(async () => {
                resultElement.textContent = "استوپ!";
                
                // نمایش تصویر استوپ
                demoVideo.style.display = 'none';
                demoImage.style.display = 'block';
                
                // پخش صدای استوپ
                await playAudioSafely(stopAudio);
                
                // ذخیره موقعیت اولیه و شروع فاز استوپ بعد از 1 ثانیه
                setTimeout(() => {
                    if (isGameActive) {
                        isStopPhase = true;
                        if (lastResults && lastResults.poseLandmarks) {
                            lastPosePositions = [
                                lastResults.poseLandmarks[11],
                                lastResults.poseLandmarks[12],
                                lastResults.poseLandmarks[23],
                                lastResults.poseLandmarks[24]
                            ];
                        }
                        
                        // بررسی برد بعد از 3 ثانیه
                        setTimeout(() => {
                            if (isGameActive) {
                                gameOver(true);
                            }
                        }, 3000);
                    }
                }, 1000);
            }, stopTime);
        }

        function stopGame() {
            isGameActive = false;
            isStopPhase = false;
            clearTimeout(gameTimeout);
            
            // نمایش تصویر
            demoVideo.style.display = 'none';
            demoImage.style.display = 'block';
            
            resultElement.textContent = "بازی متوقف شد. برای شروع مجدد دکمه سبز را بزنید یا بگو آشید شروع کن";
            
            // توقف تمام صداها
            [startAudio, jumpAudio, stopAudio, successAudio, failAudio].forEach(audio => {
                if (audio) audio.pause();
            });
        }

        async function gameOver(success) {
            isGameActive = false;
            isStopPhase = false;
            clearTimeout(gameTimeout);
            
            // نمایش تصویر
            demoVideo.style.display = 'none';
            demoImage.style.display = 'block';
            
            if (success) {
                resultElement.textContent = "آفرین! برنده شدی! 🎉";
                await playAudioSafely(successAudio);
            } else {
                resultElement.textContent = "آخ آخ تکون خوردی! دوباره تلاش کن";
                await playAudioSafely(failAudio);
            }
        }

        // توقف دوربین، ویدیو و صداها هنگام خروج از صفحه
        window.addEventListener('beforeunload', () => {
            if (camera) {
                camera.stop();
            }
            demoVideo.pause();
            
            // در دستگاه‌های غیر موبایل، تشخیص صدا را متوقف کن
            if (!isMobileDevice()) {
                if (recognition) {
                    try {
                        recognition.stop();
                        isRecognitionActive = false;
                    } catch (error) {
                        console.error('خطا در توقف تشخیص صدا:', error);
                    }
                }
            }
            
            // آزادسازی استریم صوتی پایدار در صورت وجود
            if (window.persistentAudioStream) {
                window.persistentAudioStream.getTracks().forEach(track => track.stop());
            }
            
            // توقف تمام صداها
            [startAudio, jumpAudio, stopAudio, successAudio, failAudio].forEach(audio => {
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            });
            
            // پاکسازی تایمرها
            clearTimeout(gameTimeout);
        });
        
        // مدیریت حالت‌های مختلف فعال/غیرفعال شدن صفحه
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                // صفحه پنهان شده است (کاربر به تب دیگری رفته یا برنامه را به پس‌زمینه برده)
                // در موبایل، میکروفون را متوقف نکن تا از صدای دینگ جلوگیری شود
                if (recognition && isRecognitionActive && !isMobileDevice()) {
                    try {
                        recognition.stop();
                        isRecognitionActive = false;
                    } catch (error) {
                        console.error('خطا در توقف تشخیص صدا هنگام پنهان شدن صفحه:', error);
                    }
                }
            } else if (document.visibilityState === 'visible') {
                // صفحه دوباره نمایان شده است
                if (!isRecognitionActive && !isMobileDevice()) {
                    // تلاش برای راه‌اندازی مجدد تشخیص صدا با تأخیر
                    setTimeout(() => {
                        requestAllPermissions().then(granted => {
                            if (granted) {
                                microphoneRestartAttempts = 0; // ریست کردن شمارنده تلاش‌ها
                                startSpeechRecognition();
                            }
                        });
                    }, 1000);
                }
            }
        });
        
        // تشخیص دستگاه موبایل
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // تابع برای درخواست مجوز میکروفون به صورت صریح
        async function requestMicrophonePermission() {
            // استفاده از تابع درخواست همه مجوزها
            const result = await requestAllPermissions();
            updateMicButtonStatus(result && isRecognitionActive);
            return result;
        }

        // نظارت بر تغییرات مجوز
        navigator.permissions?.query({ name: 'microphone' })
            .then(permissionStatus => {
                permissionStatus.onchange = function() {
                    console.log('وضعیت مجوز میکروفون تغییر کرد به:', this.state);
                    if (this.state === 'granted') {
                        permissionsGranted.microphone = true;
                        if (!isRecognitionActive) {
                            startSpeechRecognition();
                        }
                        updateMicButtonStatus(isRecognitionActive);
                    } else {
                        permissionsGranted.microphone = false;
                        if (isRecognitionActive && recognition) {
                            recognition.stop();
                        }
                        updateMicButtonStatus(false);
                    }
                };
            })
            .catch(error => console.error('خطا در بررسی مجوز میکروفون:', error));
            
        // درخواست مجوزها در هنگام بارگذاری صفحه
        document.addEventListener('DOMContentLoaded', requestAllPermissions);
    </script>
</body>
</html> 